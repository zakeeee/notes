# 缓存雪崩和缓存穿透

## 缓存雪崩

缓存雪崩是指缓存服务器挂掉时，或者设置了过期时间的缓存在同一时间大量过期时，所有的请求都落到数据库上，造成数据库短时间内承受大量请求而崩掉。

### 解决办法

#### 事前

首先，在使用 Redis 时，使用 **Redis 集群**或者**主从模式+哨兵**提高可用性，尽可能避免 Redis 挂掉的情况。设置缓存的过期时间时，加入一定的随机值，比如几分钟，使得缓存过期时间错开。

#### 事中

在运行中时，当缓存失效后，为了避免数据库被压垮，可以通过加锁或者队列来控制读取数据库的线程数量。（不过这会阻塞后面的请求，因此在并发量大时不适合，并且在分布式环境下可能还有分布式锁的问题）

此外可以通过增加二级缓存来减少请求打在数据库上的可能性，让一级缓存为原始缓存，二级缓存为拷贝缓存，并且二级缓存的失效时间设置得比一级更长，这样如果一级缓存失效还能使用二级缓存。

#### 事后

如果 Redis 挂掉了，可以利用 Redis 的持久化功能，将缓存数据恢复。

## 缓存穿透

缓存穿透是指客户去请求一定不在缓存中的数据，导致所有的请求都落到数据库上，造成数据库短时间内承受大量请求而崩掉。

### 解决办法

- 使用[布隆过滤器](https://zh.wikipedia.org/wiki/%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8)：将所有可能存在的数据哈希到一个足够大的 BitMap 中，一个一定不存在的数据会被 这个 BitMap 拦截掉，从而避免了对底层存储系统的查询压力。
- 缓存空结果：如果一个查询返回的数据为空（不管是数据不存在，还是系统故障），我们仍然把这个空结果进行缓存，但它的过期时间会很短，最长不超过五分钟。

参考：[https://blog.csdn.net/zeb_perfect/article/details/54135506](https://blog.csdn.net/zeb_perfect/article/details/54135506)
